<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>PhoneStock ELITE | Suite Commerciale & Comptable</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        display: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                        luxury: { 900: '#0a0a0a', 800: '#1a1a1a', 700: '#2a2a2a', accent: '#c9a227' }
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .glass-luxury {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            border-color: rgba(251, 191, 36, 0.3);
            box-shadow: 0 20px 40px -15px rgba(251, 191, 36, 0.15);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        .input-luxury {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            color: white;
        }
        .input-luxury:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
            background: rgba(255,255,255,0.08);
            outline: none;
        }

        .hidden-section { display: none !important; }
        
        .loader-ring {
            display: inline-block;
            width: 80px;
            height: 80px;
        }
        .loader-ring:after {
            content: " ";
            display: block;
            width: 64px;
            height: 64px;
            margin: 8px;
            border-radius: 50%;
            border: 6px solid #fbbf24;
            border-color: #fbbf24 transparent #fbbf24 transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(251, 191, 36, 0.4);
        }

        .nav-active {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.2) 0%, transparent 100%);
            border-left: 3px solid #fbbf24;
            color: #fbbf24 !important;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    </style>
</head>
<body class="bg-luxury-900 text-white antialiased">

    <!-- FIREBASE -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvH_-HmiV2Z9Zpw87WB26XZb_SF-mhwdU",
            authDomain: "phonestock-ci.firebaseapp.com",
            projectId: "phonestock-ci",
            storageBucket: "phonestock-ci.appspot.com",
            messagingSenderId: "343118658066",
            appId: "1:343118658066:web:576b774397170a0c9036cb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        db.enablePersistence({ synchronizeTabs: true }).catch(console.error);
    </script>

    <!-- SPLASH SCREEN -->
    <div id="splash" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="loader-ring mb-8"></div>
        <h1 class="text-4xl font-display font-bold gold-gradient mb-2">PhoneStock</h1>
        <p class="text-gray-500 text-sm tracking-[0.3em] uppercase">Edition Elite</p>
        <div class="mt-8 w-48 h-1 bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 w-0 transition-all duration-[2000ms]" id="splash-progress"></div>
        </div>
    </div>

    <!-- LOGIN LUXURY -->
    <div id="auth-screen" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=1920&q=80')] bg-cover bg-center"></div>
        <div class="absolute inset-0 bg-gradient-to-br from-black via-black/90 to-black/80 backdrop-blur-sm"></div>
        
        <div class="relative z-10 min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-md">
                <div class="text-center mb-12 animate-float">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center shadow-2xl shadow-orange-500/20">
                        <i class="fas fa-crown text-4xl text-white"></i>
                    </div>
                    <h2 class="text-4xl font-display font-bold text-white mb-2">Bienvenue</h2>
                    <p class="text-gray-400">Suite Commerciale & Comptable Premium</p>
                </div>

                <div class="glass-luxury rounded-3xl p-8">
                    <div class="flex rounded-2xl bg-black/40 p-1 mb-8">
                        <button onclick="app.switchAuth('patron')" id="auth-tab-patron" class="flex-1 py-3 rounded-xl text-sm font-semibold bg-gradient-to-r from-yellow-600 to-orange-500 text-white shadow-lg transition-all">
                            <i class="fas fa-crown mr-2"></i>Patron
                        </button>
                        <button onclick="app.switchAuth('vendeur')" id="auth-tab-vendeur" class="flex-1 py-3 rounded-xl text-sm font-semibold text-gray-400 hover:text-white transition-all">
                            <i class="fas fa-user mr-2"></i>Vendeur
                        </button>
                    </div>

                    <form id="form-patron" class="space-y-6" onsubmit="event.preventDefault();">
                        <div class="relative group">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-500 group-focus-within:text-yellow-500 transition-colors"></i>
                            <input type="email" id="email" placeholder="adresse@elite.ci" class="input-luxury w-full rounded-xl py-3.5 pl-12 pr-4 placeholder-gray-600">
                        </div>
                        <div class="relative group">
                            <i class="fas fa-lock absolute left-4 top-4 text-gray-500 group-focus-within:text-yellow-500 transition-colors"></i>
                            <input type="password" id="password" placeholder="Mot de passe s√©curis√©" class="input-luxury w-full rounded-xl py-3.5 pl-12 pr-4 placeholder-gray-600">
                        </div>
                        
                        <button onclick="app.login()" class="w-full py-4 rounded-xl btn-primary">
                            Acc√©der √† mon entreprise
                        </button>
                        
                        <p class="text-center text-sm text-gray-500">
                            Pas encore de compte ? <button onclick="app.register()" class="text-yellow-500 hover:text-yellow-400 font-semibold">Cr√©er Elite</button>
                        </p>
                    </form>

                    <div id="form-vendeur" class="hidden space-y-6">
                        <div class="text-center p-8 border-2 border-dashed border-gray-700 rounded-2xl">
                            <i class="fas fa-qrcode text-5xl text-gray-600 mb-4"></i>
                            <input type="text" id="code-access" maxlength="6" class="input-luxury w-full rounded-xl py-4 text-center text-2xl tracking-[0.5em] font-mono uppercase mb-4" placeholder="CODE">
                            <button onclick="app.accessVendor()" class="w-full py-3 rounded-xl bg-gray-800 text-white font-semibold hover:bg-gray-700 transition-all">
                                Rejoindre l'√©quipe
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-center gap-6 text-gray-600">
                    <i class="fas fa-shield-alt text-2xl" title="S√©curis√©"></i>
                    <i class="fas fa-cloud text-2xl" title="Cloud"></i>
                    <i class="fas fa-chart-line text-2xl" title="Analytics"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden min-h-screen flex flex-col lg:flex-row bg-luxury-900">
        
        <!-- SIDEBAR NAV (Desktop) -->
        <nav class="hidden lg:flex w-72 flex-col bg-black/40 backdrop-blur-xl border-r border-white/5 fixed h-full">
            <div class="p-8">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-crown text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-display font-bold text-xl text-white">PhoneStock</h1>
                        <p class="text-xs text-yellow-500 font-semibold tracking-wider uppercase">Elite Suite</p>
                    </div>
                </div>

                <div class="space-y-2" id="desktop-nav">
                    <button onclick="app.nav('dashboard')" data-view="dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all nav-active">
                        <i class="fas fa-chart-pie w-5 text-center"></i>
                        Tableau de Bord
                    </button>
                    <button onclick="app.nav('comptabilite')" data-view="comptabilite" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-book w-5 text-center"></i>
                        Comptabilit√©
                    </button>
                    <button onclick="app.nav('stock')" data-view="stock" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-box w-5 text-center"></i>
                        Stock & IMEI
                    </button>
                    <button onclick="app.nav('equipe')" data-view="equipe" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-users w-5 text-center"></i>
                        √âquipe Commerciale
                    </button>
                    <button onclick="app.nav('depenses')" data-view="depenses" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-file-invoice-dollar w-5 text-center"></i>
                        D√©penses
                    </button>
                    <button onclick="app.nav('tresorerie')" data-view="tresorerie" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-wallet w-5 text-center"></i>
                        Tr√©sorerie
                    </button>
                    <button onclick="app.nav('analyses')" data-view="analyses" class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                        <i class="fas fa-brain w-5 text-center"></i>
                        IA & Pr√©visions
                    </button>
                </div>
            </div>

            <div class="mt-auto p-6 border-t border-white/5">
                <div class="glass-luxury rounded-2xl p-4 mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-lg">
                            üë§
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-white truncate" id="user-name">Patron</p>
                            <p class="text-xs text-green-400 flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                                En ligne
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2 text-xs text-gray-400">
                        <span class="px-2 py-1 bg-white/5 rounded">Abidjan</span>
                        <span class="px-2 py-1 bg-white/5 rounded">XOF</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full py-3 rounded-xl border border-red-500/30 text-red-400 hover:bg-red-500/10 transition-all text-sm font-medium">
                    <i class="fas fa-power-off mr-2"></i>D√©connexion
                </button>
            </div>
        </nav>

        <!-- MOBILE HEADER -->
        <div class="lg:hidden fixed top-0 left-0 right-0 z-30 glass-luxury border-b border-white/5 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center">
                    <i class="fas fa-crown text-white"></i>
                </div>
                <span class="font-bold text-lg">PhoneStock</span>
            </div>
            <button onclick="app.toggleMobileMenu()" class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- MOBILE MENU -->
        <div id="mobile-menu" class="fixed inset-0 z-40 bg-black/95 backdrop-blur-xl hidden lg:hidden">
            <div class="p-6">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-display font-bold">Menu</h2>
                    <button onclick="app.toggleMobileMenu()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-2" id="mobile-nav-items">
                    <!-- Mobile nav items injected by JS -->
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto hide-scrollbar pt-20 lg:pt-0 lg:ml-72">
            
            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-4 mb-8">
                    <div>
                        <p class="text-gray-400 text-sm mb-1 uppercase tracking-wider">Vue d'ensemble</p>
                        <h2 class="text-3xl lg:text-4xl font-display font-bold text-white">Tableau de Bord</h2>
                    </div>
                    <div class="flex gap-3">
                        <input type="date" id="date-filter" class="input-luxury rounded-lg px-4 py-2 text-sm" onchange="app.filterByDate(this.value)">
                        <button onclick="app.assistant()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm font-medium hover:shadow-lg hover:shadow-purple-500/25 transition-all">
                            <i class="fas fa-robot mr-2"></i>Assistant IA
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                    <div class="glass-luxury rounded-2xl p-6 card-hover group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition-opacity">
                            <i class="fas fa-coins text-6xl text-yellow-500"></i>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Chiffre d'affaires</p>
                            </div>
                            <h3 class="text-2xl lg:text-3xl font-bold text-white mb-1" id="kpi-ca">0 CFA</h3>
                            <p class="text-xs text-green-400 flex items-center gap-1">
                                <i class="fas fa-arrow-up"></i>
                                <span id="kpi-ca-evolution">+0%</span>
                                <span class="text-gray-500 ml-1">vs hier</span>
                            </p>
                        </div>
                    </div>

                    <div class="glass-luxury rounded-2xl p-6 card-hover">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Marge Nette</p>
                        <h3 class="text-2xl lg:text-3xl font-bold text-yellow-400 mb-1" id="kpi-marge">0 CFA</h3>
                        <div class="w-full bg-gray-800 rounded-full h-1.5 mt-3">
                            <div class="bg-gradient-to-r from-yellow-600 to-yellow-400 h-1.5 rounded-full transition-all duration-1000" id="marge-progress" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2" id="marge-text">0% de marge</p>
                    </div>

                    <div class="glass-luxury rounded-2xl p-6 card-hover">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Valeur Stock</p>
                        <h3 class="text-2xl lg:text-3xl font-bold text-white mb-1" id="kpi-stock-value">0 CFA</h3>
                        <p class="text-xs text-gray-400">
                            <span class="text-blue-400" id="kpi-stock-qty">0</span> unit√©s en inventaire
                        </p>
                    </div>

                    <div class="glass-luxury rounded-2xl p-6 card-hover border border-green-500/20">
                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Tr√©sorerie Disponible</p>
                        <h3 class="text-2xl lg:text-3xl font-bold text-green-400 mb-1" id="kpi-treso">0 CFA</h3>
                        <p class="text-xs text-gray-500">Solde actuel</p>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass-luxury rounded-3xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold text-lg">Analyse des Ventes</h3>
                            <div class="flex gap-2">
                                <span class="px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-500 text-xs border border-yellow-500/20">R√©el</span>
                                <span class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-500 text-xs border border-blue-500/20">Pr√©vision IA</span>
                            </div>
                        </div>
                        <canvas id="main-chart" height="300"></canvas>
                    </div>

                    <div class="glass-luxury rounded-3xl p-6">
                        <h3 class="font-semibold text-lg mb-4">Alertes & Notifications</h3>
                        <div id="alert-list" class="space-y-3 max-h-80 overflow-y-auto hide-scrollbar">
                            <!-- Alerts injected by JS -->
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <button onclick="app.quickAction('vente')" class="glass-luxury p-4 rounded-2xl text-left hover:bg-white/5 transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-green-500/20 text-green-400 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cash-register text-xl"></i>
                        </div>
                        <p class="font-semibold text-sm">Nouvelle Vente</p>
                        <p class="text-xs text-gray-500">Vente express</p>
                    </button>
                    <button onclick="app.quickAction('transfert')" class="glass-luxury p-4 rounded-2xl text-left hover:bg-white/5 transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-blue-500/20 text-blue-400 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-exchange-alt text-xl"></i>
                        </div>
                        <p class="font-semibold text-sm">Transfert Stock</p>
                        <p class="text-xs text-gray-500">Allouer √† un vendeur</p>
                    </button>
                    <button onclick="app.quickAction('credit')" class="glass-luxury p-4 rounded-2xl text-left hover:bg-white/5 transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-orange-500/20 text-orange-400 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-hand-holding-usd text-xl"></i>
                        </div>
                        <p class="font-semibold text-sm">Cr√©dit Client</p>
                        <p class="text-xs text-gray-500">Nouvel emprunt</p>
                    </button>
                    <button onclick="app.quickAction('depense')" class="glass-luxury p-4 rounded-2xl text-left hover:bg-white/5 transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-red-500/20 text-red-400 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-file-invoice-dollar text-xl"></i>
                        </div>
                        <p class="font-semibold text-sm">Note de Frais</p>
                        <p class="text-xs text-gray-500">D√©pense interne</p>
                    </button>
                </div>
            </section>

            <!-- VIEW: COMPTABILITE -->
            <section id="view-comptabilite" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">Comptabilit√© Expert</h2>
                        <p class="text-gray-400 text-sm">Normes OHADA ‚Ä¢ TVA ‚Ä¢ Bilan automatique</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.exportBilan()" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-sm transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Bilan PDF
                        </button>
                        <button onclick="app.exportBalance()" class="px-4 py-2 rounded-xl bg-gradient-to-r from-yellow-600 to-orange-500 text-white text-sm font-medium shadow-lg transition-all">
                            <i class="fas fa-calculator mr-2"></i>Balance Excel
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="glass-luxury rounded-3xl p-6 border-t-4 border-green-500">
                        <p class="text-gray-400 text-sm mb-2">R√©sultat d'Exploitation</p>
                        <h3 class="text-3xl font-bold text-green-400 mb-2" id="compta-resultat">0 CFA</h3>
                        <p class="text-xs text-gray-500">B√©n√©fice net apr√®s charges</p>
                    </div>
                    <div class="glass-luxury rounded-3xl p-6 border-t-4 border-blue-500">
                        <p class="text-gray-400 text-sm mb-2">Total Actif</p>
                        <h3 class="text-3xl font-bold text-blue-400 mb-2" id="compta-actif">0 CFA</h3>
                        <p class="text-xs text-gray-500">Stock + Cr√©ances + Tr√©sorerie</p>
                    </div>
                    <div class="glass-luxury rounded-3xl p-6 border-t-4 border-purple-500">
                        <p class="text-gray-400 text-sm mb-2">TVA √† D√©caisser</p>
                        <h3 class="text-3xl font-bold text-purple-400 mb-2" id="compta-tva">0 CFA</h3>
                        <p class="text-xs text-gray-500">18% des ventes du mois</p>
                    </div>
                </div>

                <div class="glass-luxury rounded-3xl overflow-hidden">
                    <div class="p-6 border-b border-white/5 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h3 class="font-semibold text-lg">Grand Livre Comptable</h3>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="text" placeholder="Rechercher..." class="input-luxury rounded-lg px-4 py-2 text-sm flex-1 sm:w-64" onkeyup="app.filterCompta(this.value)">
                            <select class="input-luxury rounded-lg px-4 py-2 text-sm" onchange="app.filterComptaType(this.value)">
                                <option value="all">Toutes les op√©rations</option>
                                <option value="vente">Ventes</option>
                                <option value="achat">Achats</option>
                                <option value="depense">D√©penses</option>
                                <option value="dettes">Dettes</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">N¬∞ Compte</th>
                                    <th class="px-6 py-4 text-left">Libell√©</th>
                                    <th class="px-6 py-4 text-right">D√©bit</th>
                                    <th class="px-6 py-4 text-right">Cr√©dit</th>
                                    <th class="px-6 py-4 text-center">Type</th>
                                </tr>
                            </thead>
                            <tbody id="grand-livre-body" class="divide-y divide-white/5">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: STOCK & IMEI -->
            <section id="view-stock" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-end flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">Stock & IMEI</h2>
                        <p class="text-gray-400 text-sm">Gestion des produits et tra√ßabilit√©</p>
                    </div>
                    <button onclick="app.showAddProductModal()" class="px-6 py-3 rounded-2xl bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-semibold shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-all">
                        <i class="fas fa-plus mr-2"></i>Ajouter Produit
                    </button>
                </div>

                <div class="grid lg:grid-cols-4 gap-6 mb-6">
                    <div class="glass-luxury rounded-2xl p-6">
                        <p class="text-xs text-gray-400 uppercase">Total Unit√©s</p>
                        <h3 class="text-3xl font-bold text-white mt-2" id="stock-total-qty">0</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6">
                        <p class="text-xs text-gray-400 uppercase">Valeur d'achat</p>
                        <h3 class="text-3xl font-bold text-blue-400 mt-2" id="stock-total-achat">0 CFA</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6">
                        <p class="text-xs text-gray-400 uppercase">Valeur de vente</p>
                        <h3 class="text-3xl font-bold text-green-400 mt-2" id="stock-total-vente">0 CFA</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6">
                        <p class="text-xs text-gray-400 uppercase">Marge Potentielle</p>
                        <h3 class="text-3xl font-bold text-yellow-400 mt-2" id="stock-marge-potentielle">0 CFA</h3>
                    </div>
                </div>

                <div class="glass-luxury rounded-3xl overflow-hidden">
                    <div class="p-4 border-b border-white/5 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h3 class="font-semibold text-lg">Inventaire</h3>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="text" placeholder="Rechercher IMEI ou Mod√®le..." class="input-luxury rounded-lg px-4 py-2 text-sm flex-1 sm:w-64" onkeyup="app.filterStock(this.value)">
                            <select class="input-luxury rounded-lg px-3 py-2 text-sm" onchange="app.filterStockStatus(this.value)">
                                <option value="all">Tous</option>
                                <option value="available">Disponible</option>
                                <option value="sold">Vendu</option>
                                <option value="assigned">Assign√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto hide-scrollbar">
                        <table class="w-full text-sm">
                            <thead class="bg-white/5 text-gray-400 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">Mod√®le</th>
                                    <th class="px-6 py-4 text-left">IMEI</th>
                                    <th class="px-6 py-4 text-left">Fournisseur</th>
                                    <th class="px-6 py-4 text-right">Prix Achat</th>
                                    <th class="px-6 py-4 text-right">Prix Vente</th>
                                    <th class="px-6 py-4 text-center">Statut</th>
                                    <th class="px-6 py-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body" class="divide-y divide-white/5">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: EQUIPE -->
            <section id="view-equipe" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-end flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">√âquipe Commerciale</h2>
                        <p class="text-gray-400 text-sm">Performance & Commissions automatis√©es</p>
                    </div>
                    <button onclick="app.inviteVendor()" class="px-6 py-3 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-500 text-white font-semibold shadow-lg shadow-green-500/25 hover:shadow-green-500/40 transition-all">
                        <i class="fas fa-user-plus mr-2"></i>Inviter Vendeur
                    </button>
                </div>

                <div class="glass-luxury rounded-3xl p-6 mb-8">
                    <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                        <i class="fas fa-trophy text-yellow-500"></i>
                        Classement des Performances
                    </h3>
                    <div class="grid md:grid-cols-3 gap-4" id="podium-container">
                        <!-- Top 3 -->
                    </div>
                </div>

                <div class="grid gap-4" id="vendors-detailed-list">
                    <!-- Liste d√©taill√©e -->
                </div>
            </section>

            <!-- VIEW: DEPENSES (NEW) -->
            <section id="view-depenses" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-end flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">Gestion des D√©penses</h2>
                        <p class="text-gray-400 text-sm">Charges, factures et notes de frais</p>
                    </div>
                    <button onclick="app.showAddExpenseModal()" class="px-6 py-3 rounded-2xl bg-gradient-to-r from-red-600 to-orange-500 text-white font-semibold shadow-lg shadow-red-500/25 hover:shadow-red-500/40 transition-all">
                        <i class="fas fa-plus mr-2"></i>Nouvelle D√©pense
                    </button>
                </div>

                <div class="grid lg:grid-cols-4 gap-6 mb-6">
                    <div class="glass-luxury rounded-2xl p-6 border-l-4 border-red-500">
                        <p class="text-xs text-gray-400 uppercase">Total D√©penses (Mois)</p>
                        <h3 class="text-2xl font-bold text-red-400 mt-2" id="depense-total-mois">0 CFA</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6 border-l-4 border-orange-500">
                        <p class="text-xs text-gray-400 uppercase">Charges Fixes</p>
                        <h3 class="text-2xl font-bold text-orange-400 mt-2" id="depense-fixes">0 CFA</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6 border-l-4 border-yellow-500">
                        <p class="text-xs text-gray-400 uppercase">Charges Variables</p>
                        <h3 class="text-2xl font-bold text-yellow-400 mt-2" id="depense-variables">0 CFA</h3>
                    </div>
                    <div class="glass-luxury rounded-2xl p-6 border-l-4 border-blue-500">
                        <p class="text-xs text-gray-400 uppercase">D√©penses en attente</p>
                        <h3 class="text-2xl font-bold text-blue-400 mt-2" id="depense-attente">0 CFA</h3>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="glass-luxury rounded-3xl p-6">
                        <h3 class="font-semibold text-lg mb-4">R√©partition des Charges</h3>
                        <canvas id="expense-chart" height="250"></canvas>
                    </div>
                    
                    <div class="glass-luxury rounded-3xl overflow-hidden">
                        <div class="p-4 border-b border-white/5 flex justify-between items-center">
                            <h3 class="font-semibold text-lg">Derni√®res D√©penses</h3>
                            <select class="input-luxury rounded-lg px-3 py-1 text-xs" onchange="app.filterExpenses(this.value)">
                                <option value="all">Toutes</option>
                                <option value="fixed">Fixes</option>
                                <option value="variable">Variables</option>
                            </select>
                        </div>
                        <div class="max-h-[300px] overflow-y-auto hide-scrollbar">
                            <table class="w-full text-sm">
                                <thead class="bg-white/5 text-gray-400 text-xs uppercase sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Date</th>
                                        <th class="px-4 py-3 text-left">Cat√©gorie</th>
                                        <th class="px-4 py-3 text-left">Description</th>
                                        <th class="px-4 py-3 text-right">Montant</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-table-body" class="divide-y divide-white/5">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: TRESORERIE -->
            <section id="view-tresorerie" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">Tr√©sorerie</h2>
                        <p class="text-gray-400 text-sm">Flux de tr√©sorerie et pr√©visions</p>
                    </div>
                    <button onclick="app.showAddTransactionModal()" class="px-6 py-3 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-500 text-white font-semibold shadow-lg">
                        <i class="fas fa-exchange-alt mr-2"></i>Nouvelle Transaction
                    </button>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="glass-luxury rounded-3xl p-8 text-center border border-green-500/30">
                        <i class="fas fa-wallet text-5xl text-green-400 mb-4"></i>
                        <p class="text-gray-400 text-sm">Solde Actuel</p>
                        <h3 class="text-4xl font-bold text-white mt-2" id="treso-solde">0 CFA</h3>
                        <div class="mt-4 flex justify-center gap-2 text-xs">
                            <span class="px-3 py-1 rounded-full bg-green-500/20 text-green-400">Disponible</span>
                        </div>
                    </div>
                    
                    <div class="glass-luxury rounded-3xl p-6">
                        <h4 class="font-semibold mb-4 text-red-400">Sorties (30j)</h4>
                        <div class="space-y-3" id="treso-outflows">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                    
                    <div class="glass-luxury rounded-3xl p-6">
                        <h4 class="font-semibold mb-4 text-green-400">Entr√©es (30j)</h4>
                        <div class="space-y-3" id="treso-inflows">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>

                <div class="glass-luxury rounded-3xl p-6">
                    <h3 class="font-semibold text-lg mb-4">Historique des Mouvements</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-white/5 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">Type</th>
                                    <th class="px-6 py-4 text-left">Description</th>
                                    <th class="px-6 py-4 text-right">Entr√©e</th>
                                    <th class="px-6 py-4 text-right">Sortie</th>
                                    <th class="px-6 py-4 text-right">Solde</th>
                                </tr>
                            </thead>
                            <tbody id="treso-history" class="divide-y divide-white/5">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: ANALYSES IA -->
            <section id="view-analyses" class="hidden-section p-4 lg:p-8 max-w-7xl mx-auto space-y-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-display font-bold mb-1">IA & Pr√©visions</h2>
                        <p class="text-gray-400 text-sm">Analyse pr√©dictive et recommandations</p>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="glass-luxury rounded-3xl p-6 border border-purple-500/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                                <i class="fas fa-brain text-purple-400"></i>
                            </div>
                            <h3 class="font-semibold text-lg">Pr√©vision des Ventes</h3>
                        </div>
                        <canvas id="prediction-chart" height="200"></canvas>
                        <div class="mt-4 p-4 bg-purple-500/10 rounded-xl border border-purple-500/20">
                            <p class="text-sm text-purple-200">
                                <i class="fas fa-lightbulb mr-2"></i>
                                Pr√©vision: <strong>+23%</strong> de CA attendu demain bas√© sur l'historique des vendredis.
                            </p>
                        </div>
                    </div>

                    <div class="glass-luxury rounded-3xl p-6 border border-blue-500/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-box-open text-blue-400"></i>
                            </div>
                            <h3 class="font-semibold text-lg">Optimisation du Stock</h3>
                        </div>
                        <div class="space-y-4" id="ia-recommendations">
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>

                <div class="glass-luxury rounded-3xl p-6">
                    <h3 class="font-semibold text-lg mb-4">Analyse des Tendances</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="trend-cards">
                        <!-- Trend cards filled by JS -->
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL UNIVERSEL -->
    <div id="universal-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onclick="app.closeModalOnBackdrop(event)">
        <div class="glass-luxury w-full max-w-lg rounded-3xl p-8 transform transition-all scale-95 opacity-0 max-h-[90vh] overflow-y-auto hide-scrollbar" id="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold">Titre</h3>
                <button onclick="app.closeModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        class ElitePhoneStock {
            constructor() {
                this.user = null;
                this.boutiqueId = null;
                this.data = {
                    sales: [],
                    products: [],
                    vendors: [],
                    expenses: [],
                    transactions: [],
                    compta: []
                };
                this.currentView = 'dashboard';
                this.charts = {};
                this.init();
            }

            init() {
                // Splash screen
                setTimeout(() => {
                    document.getElementById('splash-progress').style.width = '100%';
                    setTimeout(() => {
                        document.getElementById('splash').classList.add('hidden');
                        document.getElementById('auth-screen').classList.remove('hidden');
                    }, 500);
                }, 1500);

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.user = user;
                        await this.loadProfile();
                        this.setupListeners();
                        this.enterApp();
                    }
                });

                // Setup mobile nav
                this.setupMobileNav();
            }

            setupMobileNav() {
                const desktopNav = document.getElementById('desktop-nav');
                const mobileNav = document.getElementById('mobile-nav-items');
                if (desktopNav && mobileNav) {
                    mobileNav.innerHTML = desktopNav.innerHTML;
                }
            }

            async loadProfile() {
                const doc = await db.collection('users').doc(this.user.uid).get();
                const profile = doc.data();
                this.boutiqueId = profile.boutiqueId || this.user.uid;
                this.userRole = profile.role || 'patron';
                document.getElementById('user-name').textContent = profile.nom || profile.email || 'Utilisateur';
            }

            setupListeners() {
                // Ventes temps r√©el
                db.collection('sales').where('boutiqueId', '==', this.boutiqueId)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snap => {
                        this.data.sales = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        this.updateDashboard();
                        this.updateCompta();
                        this.updateTresorerie();
                    });

                // Stock
                db.collection('products').where('boutiqueId', '==', this.boutiqueId)
                    .onSnapshot(snap => {
                        this.data.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        this.updateStockKPIs();
                        if (this.currentView === 'stock') this.renderStockTable();
                        if (this.currentView === 'dashboard') this.updateDashboard();
                    });

                // Vendeurs
                db.collection('users').where('boutiqueId', '==', this.boutiqueId)
                    .where('role', '==', 'vendeur')
                    .onSnapshot(snap => {
                        this.data.vendors = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (this.currentView === 'equipe') this.updateTeamView();
                    });

                // D√©penses
                db.collection('expenses').where('boutiqueId', '==', this.boutiqueId)
                    .orderBy('date', 'desc')
                    .onSnapshot(snap => {
                        this.data.expenses = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (this.currentView === 'depenses') this.updateDepensesView();
                        this.updateDashboard();
                    });

                // Transactions (Tr√©sorerie)
                db.collection('transactions').where('boutiqueId', '==', this.boutiqueId)
                    .orderBy('date', 'desc')
                    .onSnapshot(snap => {
                        this.data.transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (this.currentView === 'tresorerie') this.updateTresorerie();
                    });
            }

            enterApp() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                this.updateDashboard();
                this.initChart();
            }

            // AUTH
            switchAuth(mode) {
                document.getElementById('form-patron').classList.toggle('hidden', mode !== 'patron');
                document.getElementById('form-vendeur').classList.toggle('hidden', mode !== 'vendeur');
                document.getElementById('auth-tab-patron').className = mode === 'patron' 
                    ? 'flex-1 py-3 rounded-xl text-sm font-semibold bg-gradient-to-r from-yellow-600 to-orange-500 text-white shadow-lg transition-all'
                    : 'flex-1 py-3 rounded-xl text-sm font-semibold text-gray-400 hover:text-white transition-all';
                document.getElementById('auth-tab-vendeur').className = mode === 'vendeur'
                    ? 'flex-1 py-3 rounded-xl text-sm font-semibold bg-gradient-to-r from-yellow-600 to-orange-500 text-white shadow-lg transition-all'
                    : 'flex-1 py-3 rounded-xl text-sm font-semibold text-gray-400 hover:text-white transition-all';
            }

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch(e) {
                    this.showNotification(e.message, 'error');
                }
            }

            async register() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (!email || !password) return this.showNotification('Veuillez remplir tous les champs', 'error');
                try {
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(cred.user.uid).set({
                        email, role: 'patron', nom: email.split('@')[0],
                        boutiqueId: cred.user.uid, createdAt: new Date(),
                        config: { tvaRate: 18, commission: 5 }
                    });
                    this.showNotification('Compte cr√©√© avec succ√®s !', 'success');
                } catch(e) {
                    this.showNotification(e.message, 'error');
                }
            }

            async accessVendor() {
                const code = document.getElementById('code-access').value.toUpperCase();
                try {
                    const snap = await db.collection('codes').where('code', '==', code).where('used', '==', false).get();
                    if (snap.empty) return this.showNotification('Code invalide ou d√©j√† utilis√©', 'error');
                    
                    const codeDoc = snap.docs[0];
                    const data = codeDoc.data();
                    
                    // Cr√©er un compte vendeur anonyme ou demander email
                    const email = `vendeur_${Date.now()}@phonestock.temp`;
                    const password = Math.random().toString(36).slice(-8);
                    
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(cred.user.uid).set({
                        email, role: 'vendeur', nom: 'Nouveau Vendeur',
                        boutiqueId: data.boutiqueId, createdAt: new Date(),
                        code: code
                    });
                    
                    await codeDoc.ref.update({ used: true, vendorId: cred.user.uid });
                    this.showNotification('Compte vendeur cr√©√© !', 'success');
                } catch(e) {
                    this.showNotification(e.message, 'error');
                }
            }

            // NAVIGATION
            nav(view) {
                document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden-section'));
                document.getElementById('view-' + view).classList.remove('hidden-section');
                
                // Update nav active states
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('nav-active');
                    el.classList.add('text-gray-400');
                });
                
                const activeBtn = document.querySelector(`[data-view="${view}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('nav-active');
                    activeBtn.classList.remove('text-gray-400');
                }
                
                this.currentView = view;
                
                // Trigger view-specific updates
                if (view === 'equipe') this.updateTeamView();
                if (view === 'depenses') this.updateDepensesView();
                if (view === 'stock') this.renderStockTable();
                if (view === 'tresorerie') this.updateTresorerie();
                if (view === 'analyses') this.updateAnalyses();
                
                // Close mobile menu if open
                document.getElementById('mobile-menu').classList.add('hidden');
            }

            toggleMobileMenu() {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            }

            // UPDATES UI
            updateDashboard() {
                const today = new Date();
                today.setHours(0,0,0,0);
                
                // Filtrer par date si s√©lectionn√©e
                let filteredSales = this.data.sales;
                const dateFilter = document.getElementById('date-filter').value;
                if (dateFilter) {
                    const selected = new Date(dateFilter);
                    filteredSales = this.data.sales.filter(s => {
                        const d = s.timestamp?.toDate();
                        return d && d.toDateString() === selected.toDateString();
                    });
                } else {
                    // Par d√©faut: aujourd'hui
                    filteredSales = this.data.sales.filter(s => s.timestamp?.toDate() >= today);
                }
                
                const ca = filteredSales.reduce((sum, s) => sum + (s.amount || 0), 0);
                const marge = filteredSales.reduce((sum, s) => sum + ((s.amount || 0) - (s.cost || 0)), 0);
                
                // Stock valeur
                const availableStock = this.data.products.filter(p => !p.sold);
                const stockValue = availableStock.reduce((sum, p) => sum + (p.prixAchat || 0), 0);
                const stockQty = availableStock.length;
                
                // Tr√©sorerie (ventes - d√©penses)
                const totalSales = this.data.sales.reduce((sum, s) => sum + (s.amount || 0), 0);
                const totalExpenses = this.data.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const treso = totalSales - totalExpenses;
                
                this.animateValue('kpi-ca', ca);
                this.animateValue('kpi-marge', marge);
                this.animateValue('kpi-stock-value', stockValue);
                document.getElementById('kpi-stock-qty').textContent = stockQty;
                this.animateValue('kpi-treso', treso);
                
                // Progress bar marge
                const margePercent = ca > 0 ? (marge / ca) * 100 : 0;
                document.getElementById('marge-progress').style.width = margePercent + '%';
                document.getElementById('marge-text').textContent = margePercent.toFixed(1) + '% de marge';
                
                this.generateAlerts();
                this.updateChartData();
            }

            updateStockKPIs() {
                const available = this.data.products.filter(p => !p.sold);
                const totalAchat = available.reduce((sum, p) => sum + (p.prixAchat || 0), 0);
                const totalVente = available.reduce((sum, p) => sum + (p.prixVente || 0), 0);
                
                document.getElementById('stock-total-qty').textContent = available.length;
                document.getElementById('stock-total-achat').textContent = this.formatCFA(totalAchat);
                document.getElementById('stock-total-vente').textContent = this.formatCFA(totalVente);
                document.getElementById('stock-marge-potentielle').textContent = this.formatCFA(totalVente - totalAchat);
            }

            renderStockTable(filter = '') {
                const tbody = document.getElementById('stock-table-body');
                if (!tbody) return;
                
                let products = this.data.products;
                if (filter) {
                    products = products.filter(p => 
                        (p.imei || '').toLowerCase().includes(filter.toLowerCase()) ||
                        (p.modele || '').toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                tbody.innerHTML = products.map(p => {
                    let status = '<span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">Dispo</span>';
                    if (p.sold) status = '<span class="px-2 py-1 rounded-full text-xs bg-gray-500/20 text-gray-400">Vendu</span>';
                    else if (p.vendorId) status = '<span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">Assign√©</span>';
                    
                    return `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 text-gray-400">${p.date ? new Date(p.date).toLocaleDateString() : '-'}</td>
                            <td class="px-6 py-4 text-white font-medium">${p.modele || 'N/A'}</td>
                            <td class="px-6 py-4 font-mono text-xs text-gray-400">${p.imei || 'N/A'}</td>
                            <td class="px-6 py-4 text-gray-400">${p.fournisseur || '-'}</td>
                            <td class="px-6 py-4 text-right text-gray-400">${this.formatCFA(p.prixAchat)}</td>
                            <td class="px-6 py-4 text-right text-green-400">${this.formatCFA(p.prixVente)}</td>
                            <td class="px-6 py-4 text-center">${status}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="app.deleteProduct('${p.id}')" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateTeamView() {
                const container = document.getElementById('vendors-detailed-list');
                if (!container) return;
                
                const salesByVendor = {};
                this.data.sales.forEach(s => {
                    if (!salesByVendor[s.vendorId]) salesByVendor[s.vendorId] = { amount: 0, qty: 0 };
                    salesByVendor[s.vendorId].amount += (s.amount || 0);
                    salesByVendor[s.vendorId].qty += 1;
                });
                
                const ranked = this.data.vendors.map(v => ({
                    ...v,
                    ca: salesByVendor[v.id]?.amount || 0,
                    qty: salesByVendor[v.id]?.qty || 0,
                    commission: (salesByVendor[v.id]?.amount || 0) * 0.05
                })).sort((a, b) => b.ca - a.ca);
                
                const podium = document.getElementById('podium-container');
                if (podium) {
                    const top3 = ranked.slice(0, 3);
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const colors = ['border-yellow-500', 'border-gray-400', 'border-orange-600'];
                    
                    podium.innerHTML = top3.map((v, i) => `
                        <div class="relative glass-luxury rounded-2xl p-6 text-center border-t-4 ${colors[i]}">
                            <div class="text-4xl mb-2">${medals[i]}</div>
                            <div class="text-3xl mb-2">üë§</div>
                            <h4 class="font-bold text-white mb-1 truncate">${v.nom}</h4>
                            <p class="text-2xl font-bold text-yellow-400 mb-1">${this.formatCFA(v.ca)}</p>
                            <p class="text-xs text-gray-400">${v.qty} ventes ‚Ä¢ ${this.formatCFA(v.commission)} commission</p>
                        </div>
                    `).join('');
                }
                
                container.innerHTML = ranked.map(v => {
                    const assignedProducts = this.data.products.filter(p => p.vendorId === v.id && !p.sold).length;
                    return `
                        <div class="glass-luxury rounded-2xl p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-2xl">
                                    üë§
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg text-white">${v.nom}</h4>
                                    <p class="text-sm text-gray-400">${v.telephone || 'Pas de t√©l√©phone'}</p>
                                    <div class="flex gap-3 mt-2 text-xs">
                                        <span class="px-2 py-1 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20">
                                            ${assignedProducts} produits assign√©s
                                        </span>
                                        <span class="px-2 py-1 rounded-lg bg-green-500/10 text-green-400 border border-green-500/20">
                                            Actif
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-left md:text-right w-full md:w-auto">
                                <p class="text-2xl font-bold text-white">${this.formatCFA(v.ca)}</p>
                                <p class="text-sm text-gray-400">CA G√©n√©r√©</p>
                                <div class="flex gap-2 mt-2 justify-start md:justify-end">
                                    <button onclick="app.assignProductToVendor('${v.id}')" class="text-xs px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-all">
                                        Assigner stock
                                    </button>
                                    <button onclick="app.viewVendorDetail('${v.id}')" class="text-yellow-500 text-sm hover:underline">D√©tails ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateCompta() {
                const entries = [];
                
                // Ventes
                this.data.sales.forEach(s => {
                    entries.push({
                        date: s.timestamp?.toDate(),
                        dateStr: s.timestamp?.toDate().toLocaleDateString('fr-FR'),
                        account: '701',
                        label: `Vente ${s.productName || 'Produit'}`,
                        debit: 0,
                        credit: s.amount || 0,
                        type: 'vente'
                    });
                });
                
                // D√©penses
                this.data.expenses.forEach(e => {
                    entries.push({
                        date: e.date?.toDate(),
                        dateStr: e.date?.toDate().toLocaleDateString('fr-FR'),
                        account: '606',
                        label: e.description || 'D√©pense',
                        debit: e.amount || 0,
                        credit: 0,
                        type: 'depense'
                    });
                });
                
                // Trier par date
                entries.sort((a, b) => (b.date || 0) - (a.date || 0));
                
                const tbody = document.getElementById('grand-livre-body');
                if (tbody) {
                    tbody.innerHTML = entries.map(e => `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 text-gray-400">${e.dateStr}</td>
                            <td class="px-6 py-4 font-mono text-yellow-500">${e.account}</td>
                            <td class="px-6 py-4 text-white">${e.label}</td>
                            <td class="px-6 py-4 text-right text-red-400">${e.debit > 0 ? this.formatCFA(e.debit) : '-'}</td>
                            <td class="px-6 py-4 text-right text-green-400">${e.credit > 0 ? this.formatCFA(e.credit) : '-'}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="px-3 py-1 rounded-full text-xs ${e.type === 'vente' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'} border border-white/10 capitalize">${e.type}</span>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Totaux
                const totalCA = this.data.sales.reduce((sum, s) => sum + (s.amount || 0), 0);
                const totalCharges = this.data.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const resultat = totalCA - totalCharges;
                const stockValue = this.data.products.filter(p => !p.sold).reduce((sum, p) => sum + (p.prixAchat || 0), 0);
                
                if (document.getElementById('compta-resultat')) {
                    document.getElementById('compta-resultat').textContent = this.formatCFA(resultat);
                    document.getElementById('compta-resultat').className = `text-3xl font-bold mb-2 ${resultat >= 0 ? 'text-green-400' : 'text-red-400'}`;
                    document.getElementById('compta-actif').textContent = this.formatCFA(totalCA + stockValue);
                    document.getElementById('compta-tva').textContent = this.formatCFA(totalCA * 0.18);
                }
            }

            updateDepensesView() {
                const total = this.data.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                const fixes = this.data.expenses.filter(e => e.type === 'fixed').reduce((sum, e) => sum + (e.amount || 0), 0);
                const variables = this.data.expenses.filter(e => e.type === 'variable').reduce((sum, e) => sum + (e.amount || 0), 0);
                
                document.getElementById('depense-total-mois').textContent = this.formatCFA(total);
                document.getElementById('depense-fixes').textContent = this.formatCFA(fixes);
                document.getElementById('depense-variables').textContent = this.formatCFA(variables);
                document.getElementById('depense-attente').textContent = this.formatCFA(0); // √Ä impl√©menter si besoin
                
                const tbody = document.getElementById('expense-table-body');
                if (tbody) {
                    tbody.innerHTML = this.data.expenses.slice(0, 10).map(e => `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-4 py-3 text-gray-400">${e.date?.toDate().toLocaleDateString() || '-'}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs ${e.type === 'fixed' ? 'bg-orange-500/20 text-orange-400' : 'bg-yellow-500/20 text-yellow-400'}">
                                    ${e.type === 'fixed' ? 'Fixe' : 'Variable'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-white">${e.description}</td>
                            <td class="px-4 py-3 text-right text-red-400 font-mono">${this.formatCFA(e.amount)}</td>
                        </tr>
                    `).join('');
                }
                
                // Chart
                this.updateExpenseChart();
            }

            updateTresorerie() {
                const solde = this.data.transactions.reduce((sum, t) => sum + (t.type === 'in' ? t.amount : -t.amount), 0);
                document.getElementById('treso-solde').textContent = this.formatCFA(solde);
                
                // Inflows et outflows des 30 derniers jours
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                const recent = this.data.transactions.filter(t => t.date?.toDate() > thirtyDaysAgo);
                
                const inflows = recent.filter(t => t.type === 'in').reduce((sum, t) => sum + t.amount, 0);
                const outflows = recent.filter(t => t.type === 'out').reduce((sum, t) => sum + t.amount, 0);
                
                document.getElementById('treso-inflows').innerHTML = `
                    <div class="flex justify-between text-sm"><span>Ventes</span><span class="text-green-400">${this.formatCFA(inflows)}</span></div>
                    <div class="w-full bg-gray-800 rounded-full h-2"><div class="bg-green-400 h-2 rounded-full" style="width: 100%"></div></div>
                `;
                
                document.getElementById('treso-outflows').innerHTML = `
                    <div class="flex justify-between text-sm"><span>D√©penses</span><span class="text-red-400">${this.formatCFA(outflows)}</span></div>
                    <div class="w-full bg-gray-800 rounded-full h-2"><div class="bg-red-400 h-2 rounded-full" style="width: ${outflows/inflows*100 || 0}%"></div></div>
                `;
                
                // Historique
                const tbody = document.getElementById('treso-history');
                if (tbody) {
                    let runningBalance = 0;
                    const history = [...this.data.transactions].reverse().map(t => {
                        runningBalance += (t.type === 'in' ? t.amount : -t.amount);
                        return { ...t, balance: runningBalance };
                    }).reverse();
                    
                    tbody.innerHTML = history.slice(0, 20).map(t => `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="px-6 py-4 text-gray-400">${t.date?.toDate().toLocaleDateString()}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded text-xs ${t.type === 'in' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                                    ${t.type === 'in' ? 'Entr√©e' : 'Sortie'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-white">${t.description}</td>
                            <td class="px-6 py-4 text-right text-green-400">${t.type === 'in' ? this.formatCFA(t.amount) : '-'}</td>
                            <td class="px-6 py-4 text-right text-red-400">${t.type === 'out' ? this.formatCFA(t.amount) : '-'}</td>
                            <td class="px-6 py-4 text-right font-mono">${this.formatCFA(t.balance)}</td>
                        </tr>
                    `).join('');
                }
            }

            updateAnalyses() {
                // Simuler des recommandations IA
                const recommendations = [
                    { icon: 'fa-arrow-trend-up', color: 'text-green-400', bg: 'bg-green-500/10', text: 'Augmentez le stock d\'iPhone 14 Pro, forte demande pr√©vue' },
                    { icon: 'fa-triangle-exclamation', color: 'text-yellow-400', bg: 'bg-yellow-500/10', text: 'Surveillez les d√©penses de transport (+15% ce mois)' },
                    { icon: 'fa-user-check', color: 'text-blue-400', bg: 'bg-blue-500/10', text: 'Le vendeur Amadou pourrait d√©passer son objectif de 20%' }
                ];
                
                const container = document.getElementById('ia-recommendations');
                if (container) {
                    container.innerHTML = recommendations.map(r => `
                        <div class="flex items-start gap-3 p-3 rounded-xl ${r.bg} border border-white/5">
                            <i class="fas ${r.icon} ${r.color} mt-1"></i>
                            <p class="text-sm text-gray-300">${r.text}</p>
                        </div>
                    `).join('');
                }
                
                // Trend cards
                const trends = [
                    { label: 'Produit Star', value: 'iPhone 13', change: '+45%', color: 'text-green-400' },
                    { label: 'Meilleure Marge', value: 'Samsung S23', change: '32%', color: 'text-blue-400' },
                    { label: 'Rotation Stock', value: '12 jours', change: '-2j', color: 'text-yellow-400' }
                ];
                
                document.getElementById('trend-cards').innerHTML = trends.map(t => `
                    <div class="glass-luxury rounded-2xl p-6 text-center">
                        <p class="text-xs text-gray-400 uppercase mb-2">${t.label}</p>
                        <h4 class="text-2xl font-bold text-white mb-1">${t.value}</h4>
                        <p class="text-sm ${t.color}">${t.change}</p>
                    </div>
                `).join('');
                
                // Prediction chart
                this.updatePredictionChart();
            }

            generateAlerts() {
                const alerts = [];
                
                // Stock faible
                const lowStockItems = this.data.products.filter(p => !p.sold && p.prixAchat > 500000); // Exemple: produits chers
                if (lowStockItems.length < 3) {
                    alerts.push({type: 'warning', icon: 'fa-box', title: 'Stock critique', detail: `${lowStockItems.length} produits haut de gamme disponibles`});
                }
                
                // D√©penses √©lev√©es
                const monthExpenses = this.data.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                if (monthExpenses > 1000000) {
                    alerts.push({type: 'warning', icon: 'fa-money-bill', title: 'Budget d√©pass√©', detail: 'Les d√©penses mensuelles d√©passent 1M CFA'});
                }
                
                // Cr√©dits (simulation)
                alerts.push({type: 'danger', icon: 'fa-hand-holding-dollar', title: 'Cr√©dit en retard', detail: 'Kon√© Amadou - 150,000 CFA (5 jours)'});
                
                const container = document.getElementById('alert-list');
                if (container) {
                    container.innerHTML = alerts.map(a => `
                        <div class="p-4 rounded-xl bg-${a.type === 'danger' ? 'red' : 'yellow'}-500/10 border border-${a.type === 'danger' ? 'red' : 'yellow'}-500/20 flex gap-3 animate-pulse">
                            <i class="fas ${a.icon} text-${a.type === 'danger' ? 'red' : 'yellow'}-400 mt-1"></i>
                            <div>
                                <p class="text-sm font-medium text-${a.type === 'danger' ? 'red' : 'yellow'}-200">${a.title}</p>
                                <p class="text-xs text-${a.type === 'danger' ? 'red' : 'yellow'}-300/70">${a.detail}</p>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // ACTIONS RAPIDES
            quickAction(type) {
                if (type === 'vente') {
                    const available = this.data.products.filter(p => !p.sold && !p.vendorId);
                    if (available.length === 0) {
                        return this.showNotification('Aucun produit disponible en stock !', 'error');
                    }
                    
                    this.showModal('Nouvelle Vente Express', `
                        <form onsubmit="app.processQuickSale(event)" class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-2">Produit</label>
                                <select class="input-luxury w-full rounded-xl p-4" id="quick-sale-product" required>
                                    <option value="">Choisir un produit...</option>
                                    ${available.map(p => 
                                        `<option value="${p.id}" data-price="${p.prixVente}" data-cost="${p.prixAchat}">${p.modele} (IMEI: ${p.imei}) - ${this.formatCFA(p.prixVente)}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-2">Client</label>
                                <input type="text" placeholder="Nom du client" class="input-luxury w-full rounded-xl p-4" id="quick-sale-client" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-2">Paiement</label>
                                    <select class="input-luxury rounded-xl p-4 w-full" id="quick-sale-method">
                                        <option value="cash">Esp√®ces</option>
                                        <option value="om">Orange Money</option>
                                        <option value="wave">Wave</option>
                                        <option value="moov">Moov Money</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-2">Montant re√ßu</label>
                                    <input type="number" id="quick-sale-received" class="input-luxury rounded-xl p-4 w-full" required>
                                </div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-xl">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-400">Prix:</span>
                                    <span class="text-white" id="quick-sale-price">0 CFA</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Monnaie:</span>
                                    <span class="text-green-400" id="quick-sale-change">0 CFA</span>
                                </div>
                            </div>
                            <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-green-600 to-emerald-500 text-white font-bold shadow-lg hover:shadow-green-500/50 transition-all">
                                Valider la vente
                            </button>
                        </form>
                    `);
                    
                    // Auto-fill price
                    setTimeout(() => {
                        document.getElementById('quick-sale-product').addEventListener('change', (e) => {
                            const option = e.target.selectedOptions[0];
                            const price = option.dataset.price || 0;
                            document.getElementById('quick-sale-price').textContent = this.formatCFA(price);
                            document.getElementById('quick-sale-received').value = price;
                            this.calculateChange();
                        });
                        document.getElementById('quick-sale-received').addEventListener('input', () => this.calculateChange());
                    }, 100);
                } else if (type === 'depense') {
                    this.showAddExpenseModal();
                } else if (type === 'transfert') {
                    this.showTransferModal();
                } else if (type === 'credit') {
                    this.showModal('Nouveau Cr√©dit Client', `
                        <form onsubmit="app.processCredit(event)" class="space-y-4">
                            <input type="text" placeholder="Nom du client" class="input-luxury w-full rounded-xl p-4" required>
                            <input type="number" placeholder="Montant" class="input-luxury w-full rounded-xl p-4" required>
                            <input type="date" class="input-luxury w-full rounded-xl p-4" required>
                            <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-600 to-yellow-500 text-white font-bold">Enregistrer</button>
                        </form>
                    `);
                }
            }

            calculateChange() {
                const productSelect = document.getElementById('quick-sale-product');
                const received = parseFloat(document.getElementById('quick-sale-received').value) || 0;
                const price = parseFloat(productSelect.selectedOptions[0]?.dataset.price) || 0;
                const change = received - price;
                document.getElementById('quick-sale-change').textContent = this.formatCFA(change);
                document.getElementById('quick-sale-change').className = change >= 0 ? 'text-green-400' : 'text-red-400';
            }

            async processQuickSale(e) {
                e.preventDefault();
                const productId = document.getElementById('quick-sale-product').value;
                const client = document.getElementById('quick-sale-client').value;
                const method = document.getElementById('quick-sale-method').value;
                const received = parseFloat(document.getElementById('quick-sale-received').value);
                
                const product = this.data.products.find(p => p.id === productId);
                if (!product) return;
                
                try {
                    // Cr√©er la vente
                    await db.collection('sales').add({
                        boutiqueId: this.boutiqueId,
                        productId: productId,
                        productName: product.modele,
                        amount: product.prixVente,
                        cost: product.prixAchat,
                        client: client,
                        method: method,
                        received: received,
                        vendorId: this.user.uid,
                        timestamp: new Date()
                    });
                    
                    // Marquer produit comme vendu
                    await db.collection('products').doc(productId).update({ 
                        sold: true, 
                        dateVente: new Date(),
                        client: client
                    });
                    
                    // Ajouter transaction tr√©sorerie
                    await db.collection('transactions').add({
                        boutiqueId: this.boutiqueId,
                        type: 'in',
                        amount: product.prixVente,
                        description: `Vente ${product.modele} √† ${client}`,
                        date: new Date()
                    });
                    
                    this.closeModal();
                    this.showNotification('Vente enregistr√©e avec succ√®s !', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            // GESTION PRODUITS
            showAddProductModal() {
                this.showModal('Ajouter un Produit', `
                    <form onsubmit="app.processAddProduct(event)" class="space-y-4">
                        <input type="text" name="modele" placeholder="Mod√®le (ex: iPhone 14 Pro)" class="input-luxury w-full rounded-xl p-4" required>
                        <input type="text" name="imei" placeholder="Num√©ro IMEI" class="input-luxury w-full rounded-xl p-4" required>
                        <input type="text" name="fournisseur" placeholder="Fournisseur" class="input-luxury w-full rounded-xl p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" name="prixAchat" placeholder="Prix d'achat" class="input-luxury rounded-xl p-4" required>
                            <input type="number" name="prixVente" placeholder="Prix de vente" class="input-luxury rounded-xl p-4" required>
                        </div>
                        <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold shadow-lg">
                            Ajouter au Stock
                        </button>
                    </form>
                `);
            }

            async processAddProduct(e) {
                e.preventDefault();
                const form = e.target;
                try {
                    await db.collection('products').add({
                        boutiqueId: this.boutiqueId,
                        modele: form.modele.value,
                        imei: form.imei.value,
                        fournisseur: form.fournisseur.value,
                        prixAchat: parseFloat(form.prixAchat.value),
                        prixVente: parseFloat(form.prixVente.value),
                        date: new Date(),
                        sold: false,
                        vendorId: null
                    });
                    this.closeModal();
                    this.showNotification('Produit ajout√© avec succ√®s !', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            async deleteProduct(id) {
                if (!confirm('Supprimer ce produit ?')) return;
                try {
                    await db.collection('products').doc(id).delete();
                    this.showNotification('Produit supprim√©', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            // GESTION DEPENSES
            showAddExpenseModal() {
                this.showModal('Nouvelle D√©pense', `
                    <form onsubmit="app.processAddExpense(event)" class="space-y-4">
                        <input type="text" name="description" placeholder="Description (ex: Loyer, Transport...)" class="input-luxury w-full rounded-xl p-4" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" name="amount" placeholder="Montant" class="input-luxury rounded-xl p-4" required>
                            <select name="type" class="input-luxury rounded-xl p-4">
                                <option value="variable">Charge Variable</option>
                                <option value="fixed">Charge Fixe</option>
                            </select>
                        </div>
                        <select name="categorie" class="input-luxury w-full rounded-xl p-4">
                            <option value="loyer">Loyer</option>
                            <option value="salaire">Salaire</option>
                            <option value="transport">Transport</option>
                            <option value="marketing">Marketing</option>
                            <option value="autre">Autre</option>
                        </select>
                        <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-red-600 to-orange-500 text-white font-bold shadow-lg">
                            Enregistrer la d√©pense
                        </button>
                    </form>
                `);
            }

            async processAddExpense(e) {
                e.preventDefault();
                const form = e.target;
                try {
                    await db.collection('expenses').add({
                        boutiqueId: this.boutiqueId,
                        description: form.description.value,
                        amount: parseFloat(form.amount.value),
                        type: form.type.value,
                        categorie: form.categorie.value,
                        date: new Date()
                    });
                    
                    // Ajouter aussi en transaction pour la tr√©sorerie
                    await db.collection('transactions').add({
                        boutiqueId: this.boutiqueId,
                        type: 'out',
                        amount: parseFloat(form.amount.value),
                        description: form.description.value,
                        date: new Date()
                    });
                    
                    this.closeModal();
                    this.showNotification('D√©pense enregistr√©e !', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            // TRANSFERT STOCK
            showTransferModal() {
                const available = this.data.products.filter(p => !p.sold && !p.vendorId);
                this.showModal('Transfert vers Vendeur', `
                    <form onsubmit="app.processTransfer(event)" class="space-y-4">
                        <select name="product" class="input-luxury w-full rounded-xl p-4" required>
                            <option value="">Choisir un produit...</option>
                            ${available.map(p => `<option value="${p.id}">${p.modele} (${p.imei})</option>`).join('')}
                        </select>
                        <select name="vendor" class="input-luxury w-full rounded-xl p-4" required>
                            <option value="">Choisir un vendeur...</option>
                            ${this.data.vendors.map(v => `<option value="${v.id}">${v.nom}</option>`).join('')}
                        </select>
                        <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold">
                            Transf√©rer
                        </button>
                    </form>
                `);
            }

            async processTransfer(e) {
                e.preventDefault();
                const form = e.target;
                try {
                    await db.collection('products').doc(form.product.value).update({
                        vendorId: form.vendor.value,
                        dateAssignation: new Date()
                    });
                    this.closeModal();
                    this.showNotification('Produit transf√©r√© au vendeur', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            assignProductToVendor(vendorId) {
                this.showTransferModal();
                setTimeout(() => {
                    document.querySelector('[name="vendor"]').value = vendorId;
                }, 100);
            }

            async inviteVendor() {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                try {
                    await db.collection('codes').add({
                        code, boutiqueId: this.boutiqueId, used: false, createdAt: new Date()
                    });
                    this.showModal('Code d\'invitation g√©n√©r√©', `
                        <div class="text-center p-6">
                            <div class="text-4xl font-mono font-bold text-yellow-400 mb-4 tracking-widest">${code}</div>
                            <p class="text-gray-400 mb-4">Donnez ce code au nouveau vendeur pour qu'il cr√©e son compte.</p>
                            <button onclick="app.closeModal()" class="px-6 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all">Fermer</button>
                        </div>
                    `);
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            // CHARTS
            initChart() {
                const ctx = document.getElementById('main-chart');
                if (!ctx) return;
                
                this.charts.main = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Ventes R√©elles',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Pr√©vision IA',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#60a5fa',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, labels: { color: '#9ca3af' } } },
                        scales: {
                            y: { 
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#6b7280', callback: (v) => this.formatCFA(v).replace('CFA', '') }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6b7280' }
                            }
                        }
                    }
                });
            }

            updateChartData() {
                if (!this.charts.main) return;
                
                // Regrouper ventes par jour (7 derniers jours)
                const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                const data = new Array(7).fill(0);
                
                this.data.sales.forEach(s => {
                    const d = s.timestamp?.toDate();
                    if (d) {
                        const dayIndex = d.getDay();
                        data[dayIndex] += s.amount || 0;
                    }
                });
                
                this.charts.main.data.datasets[0].data = data;
                
                // Pr√©vision simple (+10% sur donn√©es r√©elles)
                this.charts.main.data.datasets[1].data = data.map(v => v * 1.1);
                this.charts.main.update();
            }

            updateExpenseChart() {
                const ctx = document.getElementById('expense-chart');
                if (!ctx) return;
                
                if (this.charts.expense) this.charts.expense.destroy();
                
                const categories = {};
                this.data.expenses.forEach(e => {
                    categories[e.categorie || 'autre'] = (categories[e.categorie || 'autre'] || 0) + (e.amount || 0);
                });
                
                this.charts.expense = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#fbbf24', '#f87171', '#60a5fa', '#34d399', '#a78bfa'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom', labels: { color: '#9ca3af', padding: 20 } }
                        }
                    }
                });
            }

            updatePredictionChart() {
                const ctx = document.getElementById('prediction-chart');
                if (!ctx) return;
                
                if (this.charts.prediction) this.charts.prediction.destroy();
                
                // G√©n√©rer donn√©es pr√©dictives fictives bas√©es sur l'historique
                const historical = this.data.sales.slice(0, 10).map(s => s.amount || 0);
                const labels = ['J-6', 'J-5', 'J-4', 'J-3', 'J-2', 'J-1', 'Auj', 'J+1', 'J+2', 'J+3'];
                
                this.charts.prediction = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Historique',
                            data: [...historical.slice(0, 7), 0, 0, 0],
                            backgroundColor: 'rgba(251, 191, 36, 0.5)',
                            borderRadius: 4
                        }, {
                            label: 'Pr√©vision',
                            data: [0, 0, 0, 0, 0, 0, historical[6] || 0, (historical[6] || 0) * 1.2, (historical[5] || 0) * 1.1, (historical[4] || 0) * 1.3],
                            backgroundColor: 'rgba(139, 92, 246, 0.5)',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#9ca3af' } } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280' } },
                            x: { grid: { display: false }, ticks: { color: '#6b7280' } }
                        }
                    }
                });
            }

            // UTILS
            animateValue(id, end) {
                const el = document.getElementById(id);
                if (!el) return;
                const start = 0;
                const duration = 1000;
                const startTime = performance.now();
                
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 3);
                    const current = Math.floor(start + (end - start) * ease);
                    el.textContent = this.formatCFA(current);
                    if (progress < 1) requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }

            formatCFA(num) {
                return new Intl.NumberFormat('fr-FR').format(num || 0) + ' CFA';
            }

            showModal(title, html) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = html;
                const modal = document.getElementById('universal-modal');
                const content = document.getElementById('modal-content');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            closeModal() {
                const modal = document.getElementById('universal-modal');
                const content = document.getElementById('modal-content');
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            }

            closeModalOnBackdrop(e) {
                if (e.target.id === 'universal-modal') this.closeModal();
            }

            showNotification(msg, type = 'info') {
                const div = document.createElement('div');
                div.className = `toast ${type}`;
                div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>${msg}`;
                document.body.appendChild(div);
                setTimeout(() => div.classList.add('show'), 100);
                setTimeout(() => {
                    div.classList.remove('show');
                    setTimeout(() => div.remove(), 300);
                }, 3000);
            }

            logout() {
                auth.signOut();
                location.reload();
            }

            exportBilan() {
                alert('G√©n√©ration du bilan PDF (Simulation)\n\nDans une vraie application, cela g√©n√©rerait un document PDF avec toutes les donn√©es comptables.');
            }

            exportBalance() {
                alert('Export Excel en cours...\n\nDans une vraie application, cela t√©l√©chargerait un fichier Excel avec la balance et le grand livre.');
            }

            // Filtres
            filterStock(search) {
                this.renderStockTable(search);
            }

            filterStockStatus(status) {
                // Simplifi√© pour la d√©mo
                this.renderStockTable();
            }

            filterCompta(search) {
                // Impl√©mentation simplifi√©e
            }

            filterComptaType(type) {
                // Impl√©mentation simplifi√©e
            }

            filterExpenses(type) {
                // Impl√©mentation simplifi√©e
            }

            filterByDate(date) {
                this.updateDashboard();
            }

            assistant() {
                const tips = [
                    "üí° Conseil: Votre marge moyenne est de " + (this.data.sales.length > 0 ? '18%' : 'N/A') + ". Envisagez d'optimiser les achats.",
                    "üìä Le stock actuel repr√©sente une valeur de " + this.formatCFA(this.data.products.reduce((s, p) => s + (p.prixAchat || 0), 0)),
                    "‚ö†Ô∏è Surveillez les d√©penses: " + this.data.expenses.length + " transactions ce mois-ci"
                ];
                this.showNotification(tips[Math.floor(Math.random() * tips.length)], 'info');
            }

            processCredit(e) {
                e.preventDefault();
                this.closeModal();
                this.showNotification('Cr√©dit enregistr√© (Simulation)', 'success');
            }

            showAddTransactionModal() {
                this.showModal('Nouvelle Transaction', `
                    <form onsubmit="app.processTransaction(event)" class="space-y-4">
                        <select name="type" class="input-luxury w-full rounded-xl p-4">
                            <option value="in">Entr√©e (Versement, etc.)</option>
                            <option value="out">Sortie (Retrait, etc.)</option>
                        </select>
                        <input type="number" name="amount" placeholder="Montant" class="input-luxury w-full rounded-xl p-4" required>
                        <input type="text" name="description" placeholder="Description" class="input-luxury w-full rounded-xl p-4" required>
                        <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-green-600 to-emerald-500 text-white font-bold">Enregistrer</button>
                    </form>
                `);
            }

            async processTransaction(e) {
                e.preventDefault();
                const form = e.target;
                try {
                    await db.collection('transactions').add({
                        boutiqueId: this.boutiqueId,
                        type: form.type.value,
                        amount: parseFloat(form.amount.value),
                        description: form.description.value,
                        date: new Date()
                    });
                    this.closeModal();
                    this.showNotification('Transaction enregistr√©e', 'success');
                } catch(err) {
                    this.showNotification(err.message, 'error');
                }
            }

            viewVendorDetail(id) {
                const vendor = this.data.vendors.find(v => v.id === id);
                if (!vendor) return;
                
                const sales = this.data.sales.filter(s => s.vendorId === id);
                const total = sales.reduce((sum, s) => sum + (s.amount || 0), 0);
                
                this.showModal(`D√©tails: ${vendor.nom}`, `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white/5 rounded-xl">
                                <p class="text-xs text-gray-400">Total Ventes</p>
                                <p class="text-xl font-bold text-white">${this.formatCFA(total)}</p>
                            </div>
                            <div class="p-4 bg-white/5 rounded-xl">
                                <p class="text-xs text-gray-400">Nombre de ventes</p>
                                <p class="text-xl font-bold text-white">${sales.length}</p>
                            </div>
                        </div>
                        <h4 class="font-semibold mt-4">Derni√®res ventes</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto hide-scrollbar">
                            ${sales.slice(0, 5).map(s => `
                                <div class="flex justify-between p-2 bg-white/5 rounded text-sm">
                                    <span>${s.productName || 'Produit'}</span>
                                    <span class="text-green-400">${this.formatCFA(s.amount)}</span>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-sm">Aucune vente</p>'}
                        </div>
                    </div>
                `);
            }
        }

        const app = new ElitePhoneStock();
    </script>
</body>
</html>
